# system-design

## Client-Server Model(Architecture)

クライアントサーバーモデルとは、**何かしらの機能や情報を提供するサーバー**と、**それを利用するクライアント**を分け、**クライアントとサーバー間をネットワーク通信によって接続**する、ソフトウェアモデル。

例えば、一人の利用者が[google](google.co.jp)を見たいとなったとき、ブラウザのURLにgoogle.co.jpと入力し、Enterを押下する。その時、ブラウザはgoogle.co.jpからIPアドレスへの変換をDNS(Domain Name System)サーバーを通じて行い、IPアドレスを使ってgoogleにアクセスされ、googleは利用者に対してgoogleの検索ページ(HTML)を利用者のブラウザに返却し、ブラウザはgoogleの検索ページを表示できる。

上記の例だと、一人の利用者のブラウザがクライアントで、[google](google.co.jp)がサーバーとなる。

DNSサーバーとは、ドメイン名(google.co.jp)を、IPアドレスに変換する仕組みを提供するサーバーのことで、`dig`コマンドでDNSサーバーの動きを確認できる。 Windows では`nslookup`コマンドで確認できる。

ブラウザの例に戻るが、IPアドレスだけだとサーバーは返答できない。  
サーバーはクライアントからのアクセスを待っているが、サーバーで動いているプログラムがポート番号も追加で指定しているため、クライアントからアクセスするには追加でポート番号が必要になる。  
そのため、ブラウザはIPアドレスとポート番号を指定してアクセスするようにしている。サイトを閲覧する際は通常**HTTP**または**HTTPS**通信が行われており、HTTPはポート番号が80番、HTTPSはポート番号が443番と定められているため、ブラウザは自動でポート番号を指定してアクセスしている。

## Network protocols

ネットワークプロトコルとは、コンピュータ間で通信を行うために取り決められた約束事。

### IP(Internet Protocol)

IPとは、インターネットでIPアドレスを使い、相手までデータをパケットにして送信するためのプロトコル。  
パケットとは、バイトで構成されたデータで、**ヘッダ(IPのバージョンなどメタデータ)**と**ペイロード(データ)**に分けられる。パケットの容量には制限があるため、**大きな容量のデータを送る際にはパケットが複数に分けて送信されるため、ロスが発生する可能性**がある。

### TCP(Transmission Control Protocol)

TCPとは、IPの上位プロトコルで、IPと一緒に用いられる。  
TCPは信頼性の高い通信を行うために使用するプロトコルであり、**パケットの再送やエラー訂正などを行う機能**がある。

- TCP通信は以下のように実現される
  - AがBに対してSYNを送信する(AからBへ通信を行いたいという要求)
  - BがAに対してACK/SYNを送信する(BからAへ通信可能という返答)
  - AがBに対してACKを送信する(AからBへ今から通信するという返答)
  - 上記手順の後はAとB間で通信が開始されているため、データを送受信することができる(また、上記手順のことをスリーウェイハンドシェイクと呼ばれる)

### HTTP

HTTPとは、WebクライアントとWebサーバー間で通信を行うために用いられる。  
TCPとともに使われている。

## Storage

ストレージとは記憶装置のこと。ハードディスクなど。  
ストレージには大きく分けて二つあり、DiskとMemoryがある。  
DiskはハードディスクやSSDなどの不揮発性メモリで、データを保存して、パソコンを再起動したとしてもデータは残っている。  
MemoryはSDRAMなどの揮発性メモリで、データを保存したとしても、パソコンを再起動するとデータは消えている。

## Latency and Throughput

レイテンシとは、クライアントがリクエストをサーバーに送って、サーバーから**応答が返ってくるまでにかかる時間**のこと。
オンラインゲームなどは通信にかかる時間を減らしたほうがいいため、スループットよりもレイテンシが優先される。

スループットは、**時間当たりに処理できるデータ量**のことで、1kbpsや1Mbpsなどの1秒あたりのデータ量をビット数で表す。
あまりにも大量のリクエストがサーバーに来てしまうと、レイテンシが低くなってしまう。

## Availability

アベイラビリティとは、可用性という意味で、**システムの耐久性を示す指標**のことで、高ければいい。
アベイラビリティ99％は言いように聞こえるが、年間でアクセスできない時間を計算すると、**3日15時間36分**となり、あまりいい結果ではない。99.99%でも52分34秒で、99.999%で5分15秒、99.9999%でようやく32秒だ。[可用性#稼働率](https://ja.wikipedia.org/wiki/%E5%8F%AF%E7%94%A8%E6%80%A7#%E7%A8%BC%E5%83%8D%E7%8E%87)

ハイアベイラビリティは、システムのすべてに対して適用するものではなく、**特に重要なもの(決済機能など)はハイアベイラビリティにする**べき。

## Redundancy

冗長性とは、予備のことで、例えば一つのサーバーだけですべてのリクエストを扱っていてそのサーバーに障害が発生してしまった場合、クライアント側は何もできなくなってしまう。これを防ぐために、予備のサーバーを複数用意し、一つのサーバーに障害が発生したら、別のサーバーに対応を任すことで、**システムの耐久性を確保**することができる。

## Caching

キャッシュとは、よく使うようなデータへのアクセスや、時間がかかるような処理を、何度もしてしまうと無駄であるため、**一時的にどこかに保存する仕組み**のこと。  
ブラウザで例えるとすると、どこかしらのウェブページへアクセスすると、文字や画像などがレスポンスとして返ってくるが、キャッシュを用いることで、初回ロード時はレスポンスに時間がかかるものの、初回アクセスでデータがクライアント側でキャッシュとして保存されているため、2回目以降は初回よりも早くアクセスすることができる。  
キャッシュが用いられるのは何もクライアントだけではなく、サーバー側や、サーバーとデータベース間でも用いることができる。

また、キャッシュを用意すべきシチュエーション、いつアクセスしても変更されないようなデータで、  
頻繁に変更されるようなデータは、キャッシュしてしまうとAのユーザは「XXX」なのに、Bのユーザでは「YYY」といった、データが一致しない可能性がある。

気を付けなければいけないのは、キャッシュと元となったデータが一致しているかだ。もしユーザーがあるデータを変更したとして、データベース内では更新されているものの、キャッシュは更新されていない場合、データが一致していないため、問題が生じる。
これを防ぐため、主に2種類方法がある。

### Write through cache

ライトスルーキャッシュとは、**キャッシュを更新した後に、データベース内のデータも更新**する。  
だが、キャッシュはメモリなので更新が早くできるが、データベースはI/Oなどでレスポンスは遅くなってしまう。

### Write back cache

ライトバックキャッシュとは、**キャッシュを更新した後に、即レスポンスを返し、データベースは5秒ごとなどで更新**する。  
この手法を利用すると、レスポンスを即返すことができ、キャッシュとデータベースのデータを同期することができる。  
しかし、サーバー側の電源供給がなくなったなどしてキャッシュにアクセスできなくなった場合、キャッシュに入っていたデータが消失してしまい、データベースとの同期化が図れなくなってしまうため、予備電源などの予防が必要。

## Proxy

プロキシとは、クライアントとサーバーの間に位置しているサーバーのこと。  
プロキシには2種類ある。

### Forward Proxy

フォワードプロキシとは、クライアントとサーバーの間に位置しているサーバーで、**クライアントの代理として振る舞うプロキシ**。  
まずクライアントからプロキシに対して、クライアントの代理としてサーバーにアクセスするように依頼し、プロキシはクライアントの代理でサーバーにアクセスする。その後サーバーはレスポンスをプロキシに返却し、プロキシはクライアントへサーバーからのレスポンスを返却する。

とあるWebサイトでユーザのIPがブラックリスト入りされている場合に、プロキシを踏み台にすることで、プロキシのIPに偽装されているのでアクセスすることができる。

### Reverse Proxy

リバースプロキシとは、クライアントとサーバーの間に位置しているサーバーで、**サーバーの代理として振る舞うプロキシ**。  
フォーワードプロキシとアクセスする流れは同じではあるが、**クライアント側はリバースプロキシの存在を知らない**。  
リバースプロキシはサーバー側で設定できるもので、クライアント側はサーバーと直にやり取りを行っているつもりでも、実際はサーバー側が用意したリバースプロキシを経由して、サーバーとのやり取りを行っている。  
フォーワードプロキシとリバースプロキシの違いは、クライアント側がプロキシの存在を知っているか、知らないか。

サーバーを秘匿し、リバースプロキシからしかアクセスを許可したくない場合。

## Load Balancers

ロードバランサーとは、クライアントとサーバーの間に位置しているサーバーで、クライアントからのリクエストを受け取り、アクセスが集中していないサーバーにリクエストを送るようにする、サーバーへの負荷を分散させる装置。

**大量のクライアントが一つのサーバー**または**一つのクライアントが大量のリクエストを一つのサーバー**に送られた場合、サーバーが対応できる分のスループットは限られているため、下手すると異常終了、またはレイテンシが遅くなる可能性がある。  
これに対応するために、サーバーを一つだけ用意するのではなく、複数用意させてクライアントそれぞれが違うサーバーに対してリクエストできるようにすればいい。ただ、クライアントとサーバーだけしかないと、クライアントはどこのサーバーにリクエストすれば処理が分散されるのかが分からない。その分散の役割を担うのがロードバランサー。

分散の方法は様々ある。  
**ラウンドロビン(Round Robin)方式**はクライアントからのリクエストをサーバーに均等にリクエストする。  
**リーストコネクション(Least Connections)方式**というのもあり、サーバーに接続されているコネクションの数が最も小さいサーバーにリクエストするという方法もある。
